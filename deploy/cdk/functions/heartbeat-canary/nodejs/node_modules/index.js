// Synthetics has a requirement on the folder structure for the canary code. It also doesn't support compiling
// TypeScript to JavaScript for now so this one is written in JavaScript.
// https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/CloudWatch_Synthetics_Canaries_WritingCanary_Nodejs.html#CloudWatch_Synthetics_Canaries_package
const synthetics = require('Synthetics');

const testHash = process.env.SNIPPETS_SEED_HASH || '';
const testBody = process.env.SNIPPETS_SEED_BODY || '';
const landingPageUrl = process.env.SNIPPETS_CLIENT_URL || '';
const detailPageUrl = `${landingPageUrl}/${testHash}`;

const config = synthetics.getConfiguration();
config.setConfig({
    includeRequestHeaders: true,
    includeResponseHeaders: true,
    includeRequestBody: true,
    includeResponseBody: true,
    harFile: true
});

exports.handler = async () => {
    const page = synthetics.getPage();

    await synthetics.executeStep('Snippet landing page', async () => {
        await page.goto(landingPageUrl);
        await page.waitForSelector('[data-testid="header"]');
        await page.waitForSelector('[data-testid="footer"]');
        await page.waitForSelector('[data-testid="editor"]');
    });

    await synthetics.executeStep('Snippet detail page', async () => {
        await page.goto(detailPageUrl);
        await page.waitForSelector('[data-testid="header"]');
        await page.waitForSelector('[data-testid="footer"]');
        const value = await page.$eval('[data-testid="preview"]', (preview) => preview.textContent);
        if (value !== testBody) {
            throw new Error('Test snippet body does not match the expected value.');
        }
    });
};
