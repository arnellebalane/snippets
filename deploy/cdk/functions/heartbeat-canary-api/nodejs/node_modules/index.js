// Synthetics has a requirement on the folder structure for the canary code. It also doesn't support compiling
// TypeScript to JavaScript for now so this one is written in JavaScript.
// https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/CloudWatch_Synthetics_Canaries_WritingCanary_Nodejs.html#CloudWatch_Synthetics_Canaries_package
const synthetics = require('Synthetics');

const testHash = process.env.SNIPPETS_SEED_HASH || '';
const testBody = process.env.SNIPPETS_SEED_BODY || '';
const detailEndpoint = `${process.env.SNIPPETS_API_URL || ''}api/snippets/${testHash}`;

const config = synthetics.getConfiguration();
config.setConfig({
    includeRequestHeaders: true,
    includeResponseHeaders: true,
    includeRequestBody: true,
    includeResponseBody: true,
    harFile: true
});

exports.handler = async () => {
    const validateSuccessful = async (response) => {
        return new Promise((resolve, reject) => {
            if (response.statusCode < 200 || response.statusCode > 299) {
                reject(new Error(response.statusCode + ' ' + response.statusMessage));
            }
            let responseBody = '';
            response.on('data', (data) => {
                responseBody += data;
            });
            response.on('end', () => {
                try {
                    const data = JSON.parse(responseBody);
                    if (data.body === testBody) {
                        resolve();
                    } else {
                        reject(new Error('Unexpected test snippet body value: ' + data.body));
                    }
                } catch (error) {
                    reject(error);
                }
            });
        });
    };

    await synthetics.executeHttpStep('Fetch snippet details', detailEndpoint, validateSuccessful);
};
